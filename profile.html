<!DOCTYPE html>
<html lang="hu">
<head>
  <link rel="icon" type="image/x-icon" href="favicon-2023.ico">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/svg+xml" href="s-atmenetes.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/svg+xml" href="s-atmenetes.svg" media="(prefers-color-scheme: dark)">
  <link rel="alternate icon" type="image/png" href="s-atmenetes.png">  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil • Schedulix Beosztáskezelő</title>
  
  <!-- Primary Meta Tags -->
  <meta name="description" content="Frissítsd a Schedulix profilodat. Kezeld a beállításaidat, profilképedet és pénznem preferenciáidat.">
  <meta name="keywords" content="profil, beosztáskezelő, munkaidő beosztás, Schedulix, profilkép, beállítások">
  <meta name="author" content="Schedulix">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.schedulix.hu/profile">
  <meta property="og:title" content="Profil • Schedulix Beosztáskezelő">
  <meta property="og:description" content="Frissítsd a Schedulix profilodat. Kezeld a beállításaidat, profilképedet és pénznem preferenciáidat.">
  <meta property="og:image" content="https://www.schedulix.hu/s-schedulix-korvonalas.png">
  <meta property="og:locale" content="hu_HU">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://www.schedulix.hu/profile">
  <meta property="twitter:title" content="Profil • Schedulix Beosztáskezelő">
  <meta property="twitter:description" content="Frissítsd a Schedulix profilodat. Kezeld a beállításaidat, profilképedet és pénznem preferenciáidat.">
  <meta property="twitter:image" content="https://www.schedulix.hu/s-schedulix-korvonalas.png">
  
  <!-- Canonical Tag -->
  <link rel="canonical" href="https://www.schedulix.hu/profile">
  
  <script>
    // Apply saved theme early to avoid flash
    (function(){
      try {
        var t = localStorage.getItem('scheduleManager_theme');
        if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        else document.documentElement.removeAttribute('data-theme');
      } catch (e) {}
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <div class="flex items-center">
          <i data-feather="calendar" class="mr-2 text-brand-color"></i>
          <span class="text-xl font-bold text-brand-color">Schedulix</span>
        </div>
        <div class="flex items-center space-x-3">
          <a href="index.html" class="nav-btn px-3 py-2 rounded-md text-sm font-medium flex items-center text-brand-color">
            <i data-feather="arrow-left" class="w-4 h-4 mr-1"></i>
            Vissza az alkalmazásba
          </a>
          <button onclick="logoutUser()" class="px-3 py-2 rounded-md text-sm font-medium bg-red-50 text-red-600 hover:bg-red-100 flex items-center">
            <i data-feather="log-out" class="w-4 h-4 mr-1"></i>
            Kilépés
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <div class="bg-white p-6 rounded-lg shadow border">
      <h2 class="text-xl font-semibold mb-1 text-brand-color">A Te profilod</h2>
      <p class="text-sm text-gray-500 mb-6">Frissítsd a profilodat.</p>

      <form id="profileForm" class="space-y-4 max-w-lg">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Felhasználónév</label>
          <input id="username" type="text" class="form-input" placeholder="például pelda_92" />
          <p class="text-xs text-gray-500 mt-1">3–20 karakter. Csak betűk, számok és aláhúzás.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Becenév</label>
          <input id="displayName" type="text" class="form-input" placeholder="Hogyan szólítsunk?" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Profilkép</label>
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-full bg-gray-100 border overflow-hidden flex items-center justify-center">
              <img id="avatarPreview" src="" alt="Aktuális profilkép" class="w-full h-full object-cover" onerror="this.style.display='none'" />
              <i data-feather="user" class="text-gray-400" id="avatarPlaceholder"></i>
            </div>
            <div>
              <input id="avatarFile" type="file" accept="image/*" class="hidden" />
              <label for="avatarFile" class="inline-flex items-center px-3 py-2 bg-white text-gray-700 border rounded-md shadow-sm hover:bg-gray-50 cursor-pointer">
                <i data-feather="upload-cloud" class="w-4 h-4 mr-2"></i>
                <span>Új kép feltöltése</span>
              </label>
              <p id="avatarFilename" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>
          <input id="avatarUrl" type="hidden" />
          <p class="text-xs text-gray-500 mt-1"></p>
        </div>
        <!-- Currency preference -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pénznem</label>
          <select id="currencySelect" class="form-select w-48">
            <option value="Ft">Ft</option>
            <option value="€">€</option>
            <option value="$">$</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">A bérek és kapcsolódó összegek megjelenítéséhez használt.</p>
        </div>
        <div id="statusBox" class="hidden text-sm"></div>
        <div class="flex gap-3">
          <button type="submit" class="px-4 py-2 bg-brand-color text-white rounded-md hover:bg-opacity-90">Változtatások mentése</button>
          <a href="index.html" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Mégse</a>
        </div>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script>
    if (typeof feather !== 'undefined') feather.replace();

    // Ensure session and redirect if not logged in
    async function ensureSession() {
      const session = await getSession();
      if (!session) {
        window.location.href = 'login.html';
        return null;
      }
      // Check if profile needs sync and perform it
      const needsSync = localStorage.getItem('scheduleManager_profile_needs_sync') === 'true';
      if (needsSync) {
        console.log('Performing delayed profile sync on profile page...');
        await performDelayedProfileSync();
      }
      return session;
    }

    // Load profile data into form
    async function loadProfile() {
      const session = await ensureSession();
      if (!session) return;
      const userId = session.user.id;
      const { data, error } = await window.supabaseClient
        .from('profiles')
        .select('username, display_name, avatar_url')
        .eq('id', userId)
        .maybeSingle();
      if (error) {
        console.error(error);
        return;
      }
      if (data) {
        document.getElementById('username').value = data.username || '';
        document.getElementById('displayName').value = data.display_name || '';
        document.getElementById('avatarUrl').value = data.avatar_url || '';
        if (data.avatar_url) {
          document.getElementById('avatarPreview').src = data.avatar_url;
          document.getElementById('avatarPlaceholder').style.display = 'none';
        }
      }
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusBox = document.getElementById('statusBox');
      statusBox.classList.add('hidden'); statusBox.textContent='';
      const session = await ensureSession();
      if (!session) return;
      const userId = session.user.id;
      const username = document.getElementById('username').value.trim();
      const display_name = document.getElementById('displayName').value.trim();
      const avatar_url = document.getElementById('avatarUrl').value.trim();

      // Validate username (3–20 chars, letters/numbers/underscores)
      const usernameOk = /^[a-zA-Z0-9_]{3,20}$/.test(username);
      if (!usernameOk) {
        statusBox.textContent = 'A felhasználónévnek 3–20 karakter hosszúnak kell lennie és csak betűket, számokat és aláhúzás jeleket tartalmazhat.';
        statusBox.classList.remove('hidden');
        statusBox.classList.add('text-red-600');
        return;
      }

      const { error } = await window.supabaseClient
        .from('profiles')
        .upsert({ id: userId, username, display_name, avatar_url })
        .select();

      // Save profile data locally
      if (username && username !== '') {
        localStorage.setItem('scheduleManager_username', username);
      } else {
        // If username is empty, remove it from localStorage
        localStorage.removeItem('scheduleManager_username');
      }
      if (display_name && display_name !== '') {
        localStorage.setItem('scheduleManager_displayName', display_name);
      } else {
        // If display_name is empty, remove it from localStorage
        localStorage.removeItem('scheduleManager_displayName');
      }
      
      // Save currency preference locally and sync to cloud state
      try {
        const currency = (document.getElementById('currencySelect') && document.getElementById('currencySelect').value) || 'Ft';
        localStorage.setItem('scheduleManager_currency', currency);
        if (typeof window.cloudSyncSave === 'function') await window.cloudSyncSave();
      } catch (_) {}

      if (error) {
        const isUnique = error.code === '23505' || (error.message || '').toLowerCase().includes('duplicate');
        statusBox.textContent = isUnique ? 'Ez a felhasználónév már foglalt. Kérjük válassz másikat.' : (error.message || 'Mentés sikertelen');
        statusBox.classList.remove('hidden');
        statusBox.classList.add('text-red-600');
      } else {
        statusBox.textContent = 'Sikeresen mentve';
        statusBox.classList.remove('hidden');
        statusBox.classList.remove('text-red-600');
        statusBox.classList.add('text-green-600');
      }
    });

    // Wait for DOM to be ready before loading profile
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProfile);
    } else {
      loadProfile();
    }
  </script>
</body>
</html>
